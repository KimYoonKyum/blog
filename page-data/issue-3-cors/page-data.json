{"componentChunkName":"component---src-templates-post-template-tsx","path":"/issue-3-cors/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<h1>문제 발생</h1>\n<ul>\n<li>현재 우리 서비스는 NextJS를 사용하여 서비스하고 있다.</li>\n<li>지난번 공유하기 기능을 맡으셨던 분이 이미지를 첨부해서 공유를 해야하는데, 로컬에 있는 이미지로만 테스트를 하시다가 서버에서 내려주는 CDN 경로에 있는 이미지를 첨부해야하는 일이 생겼다.</li>\n<li>위 내용만 보면 이상이 업지만 이전 포스팅에서 Web Api의 share 기능을 사용할 때, 이미지를 첨부하기 위해서는 이미지 파일을 받아와 blob 형태로 만들어서 파일로 추가를 해줘야했다.</li>\n<li>그래서 해당 이미지 url을 fetch 해와 blob으로 만들어 주라고 알려줬는데 여기서 CORS 에러가 나온다고 하셨다.</li>\n<li>이미 나한테 이 이야기가 들어왔을 때는 2일 동안 주니어분들 끼리 논의를 하셨었는데 몇 가지 대안은 이런거 였다.\n<ul>\n<li>cors anywhere 라는 라이브러리를 사용해서 cors 해결</li>\n<li>기획과 타협해서 프론트 쪽에서 이미지 매번 수동으로 업로드 해서 이미지 url 따로 받아오지 않게 하기</li>\n</ul>\n</li>\n<li>뭐 등등 있었지만, 이 문제는 딱 몇 줄로 해결되는 문제이다.</li>\n</ul>\n<h1>문제 해결 단계</h1>\n<ul>\n<li>사실 NextJS를 실무에서 써본 적은 이 회사가 처음이여서 해결법은 알고는 있었지만 실제 적용은 해보지 않았었다. 지식을 늘릴 수 있는 아주 좋은 기회였다.</li>\n<li>NextJS에서는 rewrites 라는 아주 좋은 기능을 제공해준다. NextJS에 쓰여있는 설명은 아래와 같다.\n<ul>\n<li><img src=\"https://user-images.githubusercontent.com/21151247/224694784-c14a394b-3237-4a42-9221-d2d00fce1c67.PNG\" alt=\"rewrite\"></li>\n<li>rewrites는 요청으로 들어온 url을 새로운 url로 매핑하는 기능을 제공하는 것이다.</li>\n<li>rewrites는 프록시 처럼 동작하고 url을 마스킹하여 전혀 다른 url 처럼 보이게 하는 것이다.</li>\n<li>redirect와는 다른 것이다. redirect는 요청으로 들어온 url을 새로운 페이지의 url로 말 그대로 리다이렉트 하는 것이다.</li>\n</ul>\n</li>\n<li>아래와 같은 코드로 문제를 해결했다.(보안상 실제 업무로 쓰인 코드는 아니지만 대충 비슷하게)\n<ul>\n<li><img src=\"https://user-images.githubusercontent.com/21151247/224697713-587d07de-34b3-4b8d-9f7b-32ff548b1eb7.png\" alt=\"code-1\"></li>\n<li><img src=\"https://user-images.githubusercontent.com/21151247/224697931-5d40e2f7-8882-4a37-90a3-51a9ce746d8c.png\" alt=\"code-2\"></li>\n</ul>\n</li>\n<li>next.conig.js 설정에서 ‘/cdn-image~’ 경로에 해당하는 것은 실제 cdn 서버로 rewrite 시켰다.</li>\n<li>그리고 서버에서 image url을 받아 왔을 때, .com 까지 최상의 도메인 다음의 경로를 파싱해 ‘/cdn-image’ 경로 뒤에 붙여서 내부적으로 호출하게 수정했다.</li>\n<li>이 몇줄로 깔끔하게 해결이 되었다.</li>\n<li>이 기능으로 CORS를 해결하는 것이 가능한 이유는 CORS는 브라우저-서버간의 규약이기 때문이다.</li>\n<li>rewrite를 설정해 두면 특정 api 요청이 발생했을 때 next 서버를 한번 거쳐서 원래 api 요청을 하기 때문에 가능하다고 생각을 했다.</li>\n<li>원래 CORS가 발생할 때 해결법 들은 여러가지 인데 그 중에 프록시 서버를 만들어서 해결하는 방법과 비슷하다는 생각이 든다.</li>\n</ul>\n<h1>아쉬웠던 점</h1>\n<ul>\n<li>Share api 사용할 때 조금만 더 신경 써줬으면, 낭비되는 시간을 줄일 수 있었을 텐데, 사수로서 약간 부족한? 모습을 보였나 생각도 들었다.</li>\n<li>현재 실무에서 어떠한 프로젝트는 서로 다른 플랫폼(JAVA,PHP 등)의 api를 호출 하고 있는데, 이전 개발자가 해놓은 것 형태는 특정 플랫폼 API를 호출해야 한다면 플래그 값을 하나 두고 코드상 매번 으로 해결하고 있었다.</li>\n<li>이걸 보고도 NextJS rewrites를 떠올려서 바로 바꾸지 못했던 내 모습을 반성한다. 현재는 거의 크런치 모드 이기 때문에 이 설정을 변경하고 api 호출 로직을 살짝 수정하기에는 테스트 시간도 촉박하니 추후에 꼭 고쳐야겠다.</li>\n</ul>\n<h1>Source</h1>\n<ul>\n<li>MDN\n<ul>\n<li><a href=\"https://developer.mozilla.org/ko/docs/Web/HTTP/CORS\" target=\"_blank\" rel=\"nofollow\">https://developer.mozilla.org/ko/docs/Web/HTTP/CORS</a></li>\n</ul>\n</li>\n<li>Next JS\n<ul>\n<li><a href=\"https://nextjs.org/docs/api-reference/next.config.js/rewrites\" target=\"_blank\" rel=\"nofollow\">https://nextjs.org/docs/api-reference/next.config.js/rewrites</a></li>\n</ul>\n</li>\n</ul>","frontmatter":{"title":"오늘의 이슈","summary":"NextJS에서 CORS 이슈","date":"2023.03.13.","categories":["NextJS","Image","CORS","issue"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQoz5WTS0iUURiGz6oQo6BtbiKI7uEi21TgsnZl5CJcGJjdI4nGdKOjpQVDZTcSu5Iwq7IoJp0spKRG8NKUwSA0oxTpyJjjjGPO/Oc88d/mHymKXvj43/N/33n5zvneI5RS6NC/f+P/DLMYYW+yobQMKGkklZQoqZlcSSOQWva/kTNCOoK22FwyQSo+bfCMFUYNkMaBZCEyVg1Wl0JfpoD3x4oZqysh8q6TCVcxo0cKCQe6+Xa3lmjFaoYunSTQVMnknTMEfV6Gb7r40FZP3L2TMU85mnNkxawGj8o34K/chH93Hj9KBS/qynjqqSa2SzBQUcDjtmsEj69DHRC8bD5EX+kS/HuXMbVH8LF6h3Ucad5hNP6TgdMrSLYU0v38Cb5z+xmvyWe4vYqO25cZPLuGL+fX4jtagGrMo79hK6HmIl67NhOsXcXISMjSswTHp+YYci8l7FlO75XtxB6uJ3FB4DuxiNF7W4i2LCZ1PZ8H7n1MNwnwCD531NBzsYhYo+CT96DlCEswMTtPr/cU/c8a6LpVRqh1Jd/f1vOms53A1Y1EvNuIhXuIzaR5df8wEX8V8ZkkfV2tfA3cYDIymLVYdsoqZ3LzOet0zsRtaPwOW8fxodJ9lUEpzfSh1JDS4nrOCGX6zuLK3iM1p8P/eQ0Lav/wovQOfwHRigRaEAJUMQAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/static/527bce94ce6c29e8f04743861f72e7e6/8f489/issue-logo.png","srcSet":"/static/527bce94ce6c29e8f04743861f72e7e6/5962e/issue-logo.png 121w,\n/static/527bce94ce6c29e8f04743861f72e7e6/79bdc/issue-logo.png 242w,\n/static/527bce94ce6c29e8f04743861f72e7e6/8f489/issue-logo.png 484w","sizes":"(min-width: 484px) 484px, 100vw"},"sources":[{"srcSet":"/static/527bce94ce6c29e8f04743861f72e7e6/6bfae/issue-logo.webp 121w,\n/static/527bce94ce6c29e8f04743861f72e7e6/a1be8/issue-logo.webp 242w,\n/static/527bce94ce6c29e8f04743861f72e7e6/a9a3d/issue-logo.webp 484w","type":"image/webp","sizes":"(min-width: 484px) 484px, 100vw"}]},"width":484,"height":263}},"publicURL":"/static/527bce94ce6c29e8f04743861f72e7e6/issue-logo.png"}}}}]}},"pageContext":{"slug":"/issue-3-cors/"}},"staticQueryHashes":[]}